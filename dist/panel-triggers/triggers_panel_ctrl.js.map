{"version":3,"sources":["../../src/panel-triggers/triggers_panel_ctrl.js"],"names":["filterTriggers","triggers","triggerFilter","utils","isRegex","_","filter","trigger","buildRegex","test","description","$","moment","PanelCtrl","triggerPanelOptionsTab","triggerPanelTriggersTab","migratePanelSchema","CURRENT_SCHEMA_VERSION","ZABBIX_DS_ID","DEFAULT_TARGET","group","host","application","tags","DEFAULT_SEVERITY","priority","severity","color","show","DEFAULT_TIME_FORMAT","PANEL_DEFAULTS","schemaVersion","datasources","targets","hostField","hostTechNameField","hostGroups","showTags","statusField","severityField","descriptionField","descriptionAtNewLine","hostsInMaintenance","showTriggers","sortTriggersBy","text","value","showEvents","limit","fontSize","pageSize","highlightBackground","highlightNewEvents","highlightNewerThan","customLastChangeFormat","lastChangeFormat","triggerSeverity","okEventColor","ackEventColor","triggerStatusMap","TriggerPanelCtrl","$scope","$injector","$timeout","datasourceSrv","templateSrv","contextSrv","dashboardSrv","backendSrv","scope","editorTabIndex","defaultTimeFormat","pageIndex","triggerList","currentTriggersPage","panel","defaultsDeep","cloneDeep","ds_groups","available_datasources","map","getZabbixDataSources","length","push","isEmpty","initDatasources","events","on","onInitEditMode","bind","onRefresh","promises","ds","get","then","datasource","zabbix","getAllGroups","groups","Promise","all","getMetricSources","meta","id","addEditorTab","timing","queryStart","Date","getTime","queryEnd","otherPanelInFullscreenMode","error","loading","setTimeQueryStart","getTriggers","setTimeQueryEnd","render","zabbixTriggers","catch","err","cancelled","console","log","message","data","emit","triggerListUnfiltered","formatTrigger","filterTriggersPost","slice","getCurrentTriggersPage","allHosts","filteredMacros","macroHostIds","curDS","triggerLimit","triggerSortField","groupFilter","replaceTemplateVars","groupsFilter","concat","indexOf","hostFilter","appFilter","triggersOptions","zabbixAPI","getHosts","hosts","each","parentTemplates","templateid","getMacros","macros","hostids","hostid","hostidsMacros","getAcknowledges","setMaintenanceStatus","filterTriggersPre","addTriggerDataSource","addTriggerMacro","flatten","results","eventids","lastEvent","eventid","event","find","acknowledges","formatAcknowledge","ack","timestamp","unix","clock","time","format","user","alias","name","surname","fullName","target","tagsFilter","replace","parseTags","every","tag","maintenance","maintenance_status","some","dsurl","zabbixurl","baseUrl","hostId","datasource_url","problem_url","charts_url","url","includes","url_macro","match","macro","toString","hostTemplate","hostMacro","orderBy","zabbixTrigger","triggerObj","hostTechName","comments","lastchangeUnix","Number","lastchange","setTriggerLastChange","setTriggerSeverity","markAckEvents","age","fromNow","tagStr","split","trim","tagParts","join","tagFilter","targetTags","newTag","uniqWith","isEqual","newFilter","tagsToString","refresh","showComment","grafana_user","ack_message","userIsEditor","isEditor","isGrafanaAdmin","disableReadOnlyUsersAck","reject","acknowledgeEvent","startPos","endPos","Math","min","groupNames","iconClass","isNewTrigger","statusClass","mainColor","secondColor","lightTheme","highlightIntervalMs","parseInterval","durationSec","now","e","elem","attrs","ctrl","pageCount","$watchGroup","renderPanel","switchPage","renderData","getContentHeight","panelHeight","height","el","currentTarget","parseInt","$apply","appendPaginationControls","footerElem","empty","ceil","startPage","max","endPage","paginationList","i","activeClass","pageLinkElem","append","setFontSize","triggerCardElem","css","rootElem","renderingCompleted","unbindDestroy","$on","off","templateUrl"],"mappings":"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","file":"triggers_panel_ctrl.js","sourcesContent":["import _ from 'lodash';\r\nimport $ from 'jquery';\r\nimport moment from 'moment';\r\nimport * as utils from '../datasource-zabbix/utils';\r\nimport {PanelCtrl} from 'app/plugins/sdk';\r\nimport {triggerPanelOptionsTab} from './options_tab';\r\nimport {triggerPanelTriggersTab} from './triggers_tab';\r\nimport {migratePanelSchema, CURRENT_SCHEMA_VERSION} from './migrations';\r\n\r\nconst ZABBIX_DS_ID = 'alexanderzobnin-zabbix-datasource';\r\n\r\nexport const DEFAULT_TARGET = {\r\n  group: {filter: \"\"},\r\n  host: {filter: \"\"},\r\n  application: {filter: \"\"},\r\n  trigger: {filter: \"\"},\r\n  tags: {filter: \"\"},\r\n};\r\n\r\nexport const DEFAULT_SEVERITY = [\r\n  {priority: 0, severity: 'Not classified', color: 'rgb(108, 108, 108)', show: true},\r\n  {priority: 1, severity: 'Information', color: 'rgb(120, 158, 183)', show: true},\r\n  {priority: 2, severity: 'Warning', color: 'rgb(175, 180, 36)', show: true},\r\n  {priority: 3, severity: 'Average', color: 'rgb(255, 137, 30)', show: true},\r\n  {priority: 4, severity: 'High', color: 'rgb(255, 101, 72)', show: true},\r\n  {priority: 5, severity: 'Disaster', color: 'rgb(215, 0, 0)', show: true},\r\n];\r\n\r\nconst DEFAULT_TIME_FORMAT = \"DD MMM YYYY HH:mm:ss\";\r\n\r\nexport const PANEL_DEFAULTS = {\r\n  schemaVersion: CURRENT_SCHEMA_VERSION,\r\n  datasources: [],\r\n  targets: {},\r\n  // Fields\r\n  hostField: true,\r\n  hostTechNameField: false,\r\n  hostGroups: false,\r\n  showTags: true,\r\n  statusField: true,\r\n  severityField: true,\r\n  descriptionField: true,\r\n  descriptionAtNewLine: false,\r\n  // Options\r\n  hostsInMaintenance: true,\r\n  showTriggers: 'all triggers',\r\n  sortTriggersBy: {text: 'last change', value: 'lastchange'},\r\n  showEvents: {text: 'Problems', value: '1'},\r\n  limit: 100,\r\n  // View options\r\n  fontSize: '100%',\r\n  pageSize: 10,\r\n  highlightBackground: false,\r\n  highlightNewEvents: false,\r\n  highlightNewerThan: '1h',\r\n  customLastChangeFormat: false,\r\n  lastChangeFormat: \"\",\r\n  // Triggers severity and colors\r\n  triggerSeverity: DEFAULT_SEVERITY,\r\n  okEventColor: 'rgb(56, 189, 113)',\r\n  ackEventColor: 'rgb(56, 219, 156)'\r\n};\r\n\r\nconst triggerStatusMap = {\r\n  '0': 'OK',\r\n  '1': 'PROBLEM'\r\n};\r\n\r\nexport class TriggerPanelCtrl extends PanelCtrl {\r\n\r\n  /** @ngInject */\r\n  constructor($scope, $injector, $timeout, datasourceSrv, templateSrv, contextSrv, dashboardSrv, backendSrv) {\r\n    super($scope, $injector);\r\n    this.datasourceSrv = datasourceSrv;\r\n    this.templateSrv = templateSrv;\r\n    this.contextSrv = contextSrv;\r\n    this.dashboardSrv = dashboardSrv;\r\n    this.backendSrv = backendSrv;\r\n    this.scope = $scope;\r\n    this.$timeout = $timeout;\r\n\r\n    this.editorTabIndex = 1;\r\n    this.triggerStatusMap = triggerStatusMap;\r\n    this.defaultTimeFormat = DEFAULT_TIME_FORMAT;\r\n    this.pageIndex = 0;\r\n    this.triggerList = [];\r\n    this.currentTriggersPage = [];\r\n    this.datasources = {};\r\n\r\n    this.panel = migratePanelSchema(this.panel);\r\n    _.defaultsDeep(this.panel, _.cloneDeep(PANEL_DEFAULTS));\r\n    this.ds_groups = {};\r\n\r\n    this.available_datasources = _.map(this.getZabbixDataSources(), 'name');\r\n    if (this.panel.datasources.length === 0) {\r\n      this.panel.datasources.push(this.available_datasources[0]);\r\n    }\r\n    if (_.isEmpty(this.panel.targets)) {\r\n      this.panel.targets[this.panel.datasources[0]] = DEFAULT_TARGET;\r\n    }\r\n\r\n    this.initDatasources();\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('refresh', this.onRefresh.bind(this));\r\n  }\r\n\r\n  initDatasources() {\r\n    let promises = _.map(this.panel.datasources, (ds) => {\r\n      // Load datasource\r\n      return this.datasourceSrv.get(ds)\r\n          .then(datasource => {\r\n            this.datasources[ds] = datasource;\r\n            datasource.zabbix.getAllGroups().then(groups => {\r\n              this.ds_groups[ds] = _.map(groups, 'name');\r\n            });\r\n            return datasource;\r\n          });\r\n    });\r\n    return Promise.all(promises);\r\n  }\r\n\r\n  getZabbixDataSources() {\r\n    return _.filter(this.datasourceSrv.getMetricSources(), datasource => {\r\n      return datasource.meta.id === ZABBIX_DS_ID && datasource.value;\r\n    });\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.addEditorTab('Triggers', triggerPanelTriggersTab, 1);\r\n    this.addEditorTab('Options', triggerPanelOptionsTab, 2);\r\n  }\r\n\r\n  setTimeQueryStart() {\r\n    this.timing.queryStart = new Date().getTime();\r\n  }\r\n\r\n  setTimeQueryEnd() {\r\n    this.timing.queryEnd = new Date().getTime();\r\n  }\r\n\r\n  onRefresh() {\r\n    // ignore fetching data if another panel is in fullscreen\r\n    if (this.otherPanelInFullscreenMode()) {\r\n      return;\r\n    }\r\n\r\n    // clear loading/error state\r\n    delete this.error;\r\n    this.loading = true;\r\n    this.setTimeQueryStart();\r\n    this.pageIndex = 0;\r\n\r\n    return this.getTriggers()\r\n        .then(zabbixTriggers => {\r\n          // Notify panel that request is finished\r\n          this.loading = false;\r\n          this.setTimeQueryEnd();\r\n\r\n          this.render(zabbixTriggers);\r\n        })\r\n        .catch(err => {\r\n          // if cancelled  keep loading set to true\r\n          if (err.cancelled) {\r\n            console.log('Panel request cancelled', err);\r\n            return;\r\n          }\r\n\r\n          this.loading = false;\r\n          this.error = err.message || \"Request Error\";\r\n\r\n          if (err.data) {\r\n            if (err.data.message) {\r\n              this.error = err.data.message;\r\n            }\r\n            if (err.data.error) {\r\n              this.error = err.data.error;\r\n            }\r\n          }\r\n\r\n          this.events.emit('data-error', err);\r\n          console.log('Panel data error:', err);\r\n        });\r\n  }\r\n\r\n  render(zabbixTriggers) {\r\n    let triggers = _.cloneDeep(zabbixTriggers || this.triggerListUnfiltered);\r\n    this.triggerListUnfiltered = _.cloneDeep(triggers);\r\n\r\n    triggers = _.map(triggers, this.formatTrigger.bind(this));\r\n    triggers = this.filterTriggersPost(triggers);\r\n    // triggers = this.sortTriggers(triggers);\r\n\r\n    // Limit triggers number\r\n    triggers = triggers.slice(0, this.panel.limit || PANEL_DEFAULTS.limit);\r\n\r\n    this.triggerList = triggers;\r\n    this.getCurrentTriggersPage();\r\n\r\n    this.$timeout(() => {\r\n      super.render(this.triggerList);\r\n    });\r\n  }\r\n\r\n  getTriggers() {\r\n    let allHosts = [];\r\n    let filteredMacros = [];\r\n    let macroHostIds = [];\r\n    let curDS = null;\r\n    let promises = _.map(this.panel.datasources, (ds) => {\r\n      return this.datasourceSrv.get(ds)\r\n          .then(datasource => {\r\n            var zabbix = datasource.zabbix;\r\n            var showEvents = this.panel.showEvents.value;\r\n            var triggerFilter = this.panel.targets[ds];\r\n            var triggerLimit = this.panel.limit;\r\n            var triggerSortField = this.panel.sortTriggersBy.value;\r\n\r\n            // Replace template variables\r\n            var groupFilter = datasource.replaceTemplateVars(triggerFilter.group.filter);\r\n            var groupsFilter = [];\r\n            if (triggerFilter.groups) {\r\n              groupsFilter = groupsFilter.concat(triggerFilter.groups.filter);\r\n            }\r\n            if (groupsFilter.indexOf(groupFilter) < 0 && groupFilter !== \"\") {\r\n              groupsFilter.push(groupFilter);\r\n            }\r\n            if (groupsFilter.indexOf('all') >= 0){\r\n              groupsFilter = [];\r\n            }\r\n            var hostFilter = datasource.replaceTemplateVars(triggerFilter.host.filter);\r\n            var appFilter = datasource.replaceTemplateVars(triggerFilter.application.filter);\r\n\r\n            let triggersOptions = {\r\n              showTriggers: showEvents,\r\n              triggerLimit: triggerLimit,\r\n              triggerSortField: triggerSortField\r\n            };\r\n\r\n            curDS = datasource;\r\n            datasource.zabbix.zabbixAPI.getHosts().then(hosts => {\r\n              allHosts = hosts;\r\n              _.each(hosts, function (host) {\r\n                if (host.parentTemplates[0]){\r\n                  macroHostIds.push(host.parentTemplates[0].templateid);\r\n                }\r\n              });\r\n              return macroHostIds;\r\n            }).then(macroHostIds => {\r\n              curDS.zabbix.getMacros(macroHostIds).then(macros => {\r\n                filteredMacros = filteredMacros.concat(macros);\r\n                return macros;\r\n              });\r\n            });\r\n\r\n            return zabbix.getTriggers(groupsFilter, hostFilter, appFilter, triggersOptions);\r\n          }).then(triggers => {\r\n            let hostids = _.map(triggers, function (trigger) {\r\n              if (trigger.hosts){\r\n                return trigger.hosts[0].hostid;\r\n              }\r\n            });\r\n            let hostidsMacros = curDS.zabbix.getMacros(hostids).then(macros => {\r\n              filteredMacros = filteredMacros.concat(macros);\r\n              return triggers;\r\n            });\r\n            return hostidsMacros;\r\n          }).then((triggers) => {\r\n            return this.getAcknowledges(triggers, ds);\r\n          }).then((triggers) => {\r\n            return this.setMaintenanceStatus(triggers);\r\n          }).then((triggers) => {\r\n            return this.filterTriggersPre(triggers, ds);\r\n          }).then((triggers) => {\r\n            return this.addTriggerDataSource(triggers, ds);\r\n          }).then(triggers => {\r\n            return this.addTriggerMacro(triggers, filteredMacros, allHosts);\r\n          });\r\n    });\r\n\r\n    return Promise.all(promises)\r\n        .then(results => _.flatten(results));\r\n  }\r\n\r\n  getAcknowledges(triggerList, ds) {\r\n    // Request acknowledges for trigger\r\n    var eventids = _.map(triggerList, trigger => {\r\n      return trigger.lastEvent.eventid;\r\n    });\r\n\r\n    return this.datasources[ds].zabbix.getAcknowledges(eventids)\r\n        .then(events => {\r\n\r\n          // Map events to triggers\r\n          _.each(triggerList, trigger => {\r\n            var event = _.find(events, event => {\r\n              return event.eventid === trigger.lastEvent.eventid;\r\n            });\r\n\r\n            if (event) {\r\n              trigger.acknowledges = _.map(event.acknowledges, this.formatAcknowledge.bind(this));\r\n            }\r\n\r\n            if (!trigger.lastEvent.eventid) {\r\n              trigger.lastEvent = null;\r\n            }\r\n          });\r\n\r\n          return triggerList;\r\n        });\r\n  }\r\n\r\n  formatAcknowledge(ack) {\r\n    let timestamp = moment.unix(ack.clock);\r\n    if (this.panel.customLastChangeFormat) {\r\n      ack.time = timestamp.format(this.panel.lastChangeFormat);\r\n    } else {\r\n      ack.time = timestamp.format(this.defaultTimeFormat);\r\n    }\r\n    ack.user = ack.alias || '';\r\n    if (ack.name || ack.surname) {\r\n      const fullName = `${ack.name || ''} ${ack.surname || ''}`;\r\n      ack.user += ` (${fullName})`;\r\n    }\r\n    return ack;\r\n  }\r\n\r\n  filterTriggersPre(triggerList, ds) {\r\n    // Filter triggers by description\r\n    let triggerFilter = this.panel.targets[ds].trigger.filter;\r\n    triggerFilter = this.datasources[ds].replaceTemplateVars(triggerFilter);\r\n    if (triggerFilter) {\r\n      triggerList = filterTriggers(triggerList, triggerFilter);\r\n    }\r\n\r\n    // Filter by tags\r\n    const target = this.panel.targets[ds];\r\n    if (target.tags.filter) {\r\n      let tagsFilter = this.datasources[ds].replaceTemplateVars(target.tags.filter);\r\n      // replaceTemplateVars() builds regex-like string, so we should trim it.\r\n      tagsFilter = tagsFilter.replace('/^', '').replace('$/', '');\r\n      const tags = this.parseTags(tagsFilter);\r\n      triggerList = _.filter(triggerList, trigger => {\r\n        return _.every(tags, (tag) => {\r\n          return _.find(trigger.tags, {tag: tag.tag, value: tag.value});\r\n        });\r\n      });\r\n    }\r\n\r\n    return triggerList;\r\n  }\r\n\r\n  filterTriggersPost(triggers) {\r\n    let triggerList = _.cloneDeep(triggers);\r\n\r\n    // Filter acknowledged triggers\r\n    if (this.panel.showTriggers === 'unacknowledged') {\r\n      triggerList = _.filter(triggerList, trigger => {\r\n        return !trigger.acknowledges;\r\n      });\r\n    } else if (this.panel.showTriggers === 'acknowledged') {\r\n      triggerList = _.filter(triggerList, 'acknowledges');\r\n    } else {\r\n      triggerList = triggerList;\r\n    }\r\n\r\n    // Filter by maintenance status\r\n    if (!this.panel.hostsInMaintenance) {\r\n      triggerList = _.filter(triggerList, (trigger) => trigger.maintenance === false);\r\n    }\r\n\r\n    // Filter triggers by severity\r\n    triggerList = _.filter(triggerList, trigger => {\r\n      return this.panel.triggerSeverity[trigger.priority].show;\r\n    });\r\n\r\n    return triggerList;\r\n  }\r\n\r\n  setMaintenanceStatus(triggers) {\r\n    _.each(triggers, (trigger) => {\r\n      let maintenance_status = _.some(trigger.hosts, (host) => host.maintenance_status === '1');\r\n      trigger.maintenance = maintenance_status;\r\n    });\r\n    return triggers;\r\n  }\r\n\r\n  addTriggerDataSource(triggers, ds) {\r\n    var dsurl = this.panel.targets[ds].zabbixurl;\r\n    var baseUrl;\r\n    if (!dsurl) {\r\n      baseUrl = null;\r\n    }\r\n    else {\r\n      baseUrl = dsurl.filter;\r\n    }\r\n\r\n    _.each(triggers, (trigger) => {\r\n      trigger.datasource = ds;\r\n      if (baseUrl) {\r\n        if (trigger.hosts) {\r\n          let hostId = trigger.hosts[0].hostid;\r\n          trigger.datasource_url = baseUrl + 'hostinventories.php?hostid=' + hostId;\r\n          trigger.problem_url = baseUrl + 'zabbix.php?action=problem.view&page=1&filter_show=1&filter_set=1&filter_hostids[]=' + hostId;\r\n          trigger.charts_url = baseUrl + 'charts.php?fullscreen=0&groupid=0&graphid=0&hostid=' + hostId;\r\n        }\r\n        else {\r\n          trigger.datasource_url = baseUrl;\r\n        }\r\n      } else {\r\n        trigger.datasource_url = null;\r\n      }\r\n    });\r\n    return triggers;\r\n  }\r\n\r\n  addTriggerMacro(triggers, filteredMacros, allHosts) {\r\n    _.each(triggers, function (trigger) {\r\n      if (trigger.url && _.includes(trigger.url, \"{$\")){\r\n        let url_macro = trigger.url.match(/{\\$\\w+}/)[0];\r\n        let macro = _.find(filteredMacros, {macro: url_macro, hostid: trigger.hosts[0].hostid.toString()});\r\n        if (macro){\r\n          trigger.url = _.replace(trigger.url, url_macro, macro.value);\r\n        }\r\n        else {\r\n          let hostTemplate = _.find(allHosts, {hostid: trigger.hosts[0].hostid.toString()});\r\n          if(hostTemplate) {\r\n            let hostMacro = _.find(filteredMacros, {macro: url_macro, hostid: hostTemplate.parentTemplates[0].templateid.toString()});\r\n            if(hostMacro){\r\n              trigger.url = _.replace(trigger.url, url_macro, hostMacro.value);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n    return triggers;\r\n  }\r\n\r\n  sortTriggers(triggerList) {\r\n    if (this.panel.sortTriggersBy.value === 'priority') {\r\n      triggerList = _.orderBy(triggerList, ['priority', 'lastchangeUnix', 'triggerid'], ['desc', 'desc', 'desc']);\r\n    } else {\r\n      triggerList = _.orderBy(triggerList, ['lastchangeUnix', 'priority', 'triggerid'], ['desc', 'desc', 'desc']);\r\n    }\r\n    return triggerList;\r\n  }\r\n\r\n  formatTrigger(zabbixTrigger) {\r\n    let trigger = _.cloneDeep(zabbixTrigger);\r\n    let triggerObj = trigger;\r\n\r\n    // Set host that the trigger belongs\r\n    if (trigger.hosts && trigger.hosts.length) {\r\n      triggerObj.host = trigger.hosts[0].name;\r\n      triggerObj.hostTechName = trigger.hosts[0].host;\r\n    }\r\n\r\n    // Set tags if present\r\n    if (trigger.tags && trigger.tags.length === 0) {\r\n      trigger.tags = null;\r\n    }\r\n\r\n    // Handle multi-line description\r\n    if (trigger.comments) {\r\n      trigger.comments = trigger.comments.replace('\\n', '<br>');\r\n    }\r\n\r\n    // Format last change and age\r\n    trigger.lastchangeUnix = Number(trigger.lastchange);\r\n    triggerObj = this.setTriggerLastChange(triggerObj);\r\n    triggerObj = this.setTriggerSeverity(triggerObj);\r\n    return triggerObj;\r\n  }\r\n\r\n  updateTriggerFormat(trigger) {\r\n    trigger = this.setTriggerLastChange(trigger);\r\n    trigger = this.setTriggerSeverity(trigger);\r\n    return trigger;\r\n  }\r\n\r\n  setTriggerSeverity(trigger) {\r\n    if (trigger.value === '1') {\r\n      // Problem state\r\n      trigger.color = this.panel.triggerSeverity[trigger.priority].color;\r\n    } else {\r\n      // OK state\r\n      trigger.color = this.panel.okEventColor;\r\n    }\r\n    trigger.severity = this.panel.triggerSeverity[trigger.priority].severity;\r\n\r\n    // Mark acknowledged triggers with different color\r\n    if (this.panel.markAckEvents && trigger.acknowledges && trigger.acknowledges.length) {\r\n      trigger.color = this.panel.ackEventColor;\r\n    }\r\n\r\n    return trigger;\r\n  }\r\n\r\n  setTriggerLastChange(trigger) {\r\n    if (!trigger.lastchangeUnix) {\r\n      trigger.lastchange = \"\";\r\n      trigger.age = \"\";\r\n      return trigger;\r\n    }\r\n\r\n    let timestamp = moment.unix(trigger.lastchangeUnix);\r\n    if (this.panel.customLastChangeFormat) {\r\n      // User defined format\r\n      trigger.lastchange = timestamp.format(this.panel.lastChangeFormat);\r\n    } else {\r\n      trigger.lastchange = timestamp.format(this.defaultTimeFormat);\r\n    }\r\n    trigger.age = timestamp.fromNow(true);\r\n    return trigger;\r\n  }\r\n\r\n  parseTags(tagStr) {\r\n    if (!tagStr) {\r\n      return [];\r\n    }\r\n\r\n    let tags = _.map(tagStr.split(','), (tag) => tag.trim());\r\n    tags = _.map(tags, (tag) => {\r\n      const tagParts = tag.split(':');\r\n      return {tag: tagParts[0].trim(), value: tagParts[1].trim()};\r\n    });\r\n    return tags;\r\n  }\r\n\r\n  tagsToString(tags) {\r\n    return _.map(tags, (tag) => `${tag.tag}:${tag.value}`).join(', ');\r\n  }\r\n\r\n  addTagFilter(tag, ds) {\r\n    let tagFilter = this.panel.targets[ds].tags.filter;\r\n    let targetTags = this.parseTags(tagFilter);\r\n    let newTag = {tag: tag.tag, value: tag.value};\r\n    targetTags.push(newTag);\r\n    targetTags = _.uniqWith(targetTags, _.isEqual);\r\n    let newFilter = this.tagsToString(targetTags);\r\n    this.panel.targets[ds].tags.filter = newFilter;\r\n    this.refresh();\r\n  }\r\n\r\n  switchComment(trigger) {\r\n    trigger.showComment = !trigger.showComment;\r\n  }\r\n\r\n  acknowledgeTrigger(trigger, message) {\r\n    let eventid = trigger.lastEvent ? trigger.lastEvent.eventid : null;\r\n    let grafana_user = this.contextSrv.user.name;\r\n    let ack_message = grafana_user + ' (Grafana): ' + message;\r\n    return this.datasourceSrv.get(trigger.datasource)\r\n        .then(datasource => {\r\n          const userIsEditor = this.contextSrv.isEditor || this.contextSrv.isGrafanaAdmin;\r\n          if (datasource.disableReadOnlyUsersAck && !userIsEditor) {\r\n            return Promise.reject({message: 'You have no permissions to acknowledge events.'});\r\n          }\r\n          if (eventid) {\r\n            return datasource.zabbix.zabbixAPI.acknowledgeEvent(eventid, ack_message);\r\n          } else {\r\n            return Promise.reject({message: 'Trigger has no events. Nothing to acknowledge.'});\r\n          }\r\n        })\r\n        .then(this.onRefresh.bind(this))\r\n        .catch((err) => {\r\n          this.error = err.message || \"Acknowledge Error\";\r\n          this.events.emit('data-error', err);\r\n          console.log('Panel data error:', err);\r\n        });\r\n  }\r\n\r\n  getCurrentTriggersPage() {\r\n    let pageSize = this.panel.pageSize || PANEL_DEFAULTS.pageSize;\r\n    let startPos = this.pageIndex * pageSize;\r\n    let endPos = Math.min(startPos + pageSize, this.triggerList.length);\r\n    this.currentTriggersPage = this.triggerList.slice(startPos, endPos);\r\n    return this.currentTriggersPage;\r\n  }\r\n\r\n  formatHostName(trigger) {\r\n    let host = \"\";\r\n    if (this.panel.hostField && this.panel.hostTechNameField) {\r\n      host = `${trigger.host} (${trigger.hostTechName})`;\r\n    } else if (this.panel.hostField || this.panel.hostTechNameField) {\r\n      host = this.panel.hostField ? trigger.host : trigger.hostTechName;\r\n    }\r\n\r\n    return host;\r\n  }\r\n\r\n  formatHostGroups(trigger) {\r\n    let groupNames = \"\";\r\n    if (this.panel.hostGroups) {\r\n      let groups = _.map(trigger.groups, 'name').join(', ');\r\n      groupNames += `[ ${groups} ]`;\r\n    }\r\n\r\n    return groupNames;\r\n  }\r\n\r\n  getAlertIconClass(trigger) {\r\n    let iconClass = '';\r\n    if (trigger.value === '1') {\r\n      if (trigger.priority >= 3) {\r\n        iconClass = 'icon-gf-critical';\r\n      } else {\r\n        iconClass = 'icon-gf-warning';\r\n      }\r\n    } else {\r\n      iconClass = 'icon-gf-online';\r\n    }\r\n\r\n    if (this.panel.highlightNewEvents && this.isNewTrigger(trigger)) {\r\n      iconClass += ' zabbix-trigger--blinked';\r\n    }\r\n    return iconClass;\r\n  }\r\n\r\n  getAlertIconClassBySeverity(triggerSeverity) {\r\n    let iconClass = 'icon-gf-warning';\r\n    if (triggerSeverity.priority >= 3) {\r\n      iconClass = 'icon-gf-critical';\r\n    }\r\n    return iconClass;\r\n  }\r\n\r\n  getAlertStateClass(trigger) {\r\n    let statusClass = '';\r\n\r\n    if (trigger.value === '1') {\r\n      statusClass = 'alert-state-critical';\r\n    } else {\r\n      statusClass = 'alert-state-ok';\r\n    }\r\n\r\n    if (this.panel.highlightNewEvents && this.isNewTrigger(trigger)) {\r\n      statusClass += ' zabbix-trigger--blinked';\r\n    }\r\n\r\n    return statusClass;\r\n  }\r\n\r\n  getBackground(trigger) {\r\n    const mainColor = trigger.color;\r\n    const secondColor = this.contextSrv.user.lightTheme ? '#dde4ed' : '#262628';\r\n    if (this.contextSrv.user.lightTheme) {\r\n      return `linear-gradient(135deg, ${secondColor}, ${mainColor})`;\r\n    }\r\n    return `linear-gradient(135deg, ${mainColor}, ${secondColor})`;\r\n  }\r\n\r\n  isNewTrigger(trigger) {\r\n    try {\r\n      const highlightIntervalMs = utils.parseInterval(this.panel.highlightNewerThan || PANEL_DEFAULTS.highlightNewerThan);\r\n      const durationSec = (Date.now() - trigger.lastchangeUnix * 1000);\r\n      return durationSec < highlightIntervalMs;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  link(scope, elem, attrs, ctrl) {\r\n    let panel = ctrl.panel;\r\n    let pageCount = 0;\r\n    let triggerList = ctrl.triggerList;\r\n\r\n    scope.$watchGroup(['ctrl.currentTriggersPage', 'ctrl.triggerList'], renderPanel);\r\n    elem.on('click', '.triggers-panel-page-link', switchPage);\r\n    ctrl.events.on('render', (renderData) => {\r\n      triggerList = renderData || triggerList;\r\n      renderPanel();\r\n    });\r\n\r\n    function getContentHeight() {\r\n      let panelHeight = ctrl.height;\r\n      if (pageCount > 1) {\r\n        panelHeight -= 36;\r\n      }\r\n      return panelHeight + 'px';\r\n    }\r\n\r\n    function switchPage(e) {\r\n      let el = $(e.currentTarget);\r\n      ctrl.pageIndex = (parseInt(el.text(), 10) - 1);\r\n\r\n      let pageSize = panel.pageSize || 10;\r\n      let startPos = ctrl.pageIndex * pageSize;\r\n      let endPos = Math.min(startPos + pageSize, triggerList.length);\r\n      ctrl.currentTriggersPage = triggerList.slice(startPos, endPos);\r\n\r\n      scope.$apply(() => {\r\n        renderPanel();\r\n      });\r\n    }\r\n\r\n    function appendPaginationControls(footerElem) {\r\n      footerElem.empty();\r\n\r\n      let pageSize = panel.pageSize || 5;\r\n      pageCount = Math.ceil(triggerList.length / pageSize);\r\n      if (pageCount === 1) {\r\n        return;\r\n      }\r\n\r\n      let startPage = Math.max(ctrl.pageIndex - 3, 0);\r\n      let endPage = Math.min(pageCount, startPage + 9);\r\n\r\n      let paginationList = $('<ul></ul>');\r\n\r\n      for (let i = startPage; i < endPage; i++) {\r\n        let activeClass = i === ctrl.pageIndex ? 'active' : '';\r\n        let pageLinkElem = $('<li><a class=\"triggers-panel-page-link pointer ' + activeClass + '\">' + (i + 1) + '</a></li>');\r\n        paginationList.append(pageLinkElem);\r\n      }\r\n\r\n      footerElem.append(paginationList);\r\n    }\r\n\r\n    function setFontSize() {\r\n      const fontSize = parseInt(panel.fontSize.slice(0, panel.fontSize.length - 1));\r\n      let triggerCardElem = elem.find('.alert-rule-item');\r\n      if (fontSize && fontSize !== 100) {\r\n        triggerCardElem.find('.alert-rule-item__icon').css({\r\n          'font-size': fontSize + '%',\r\n          'margin': fontSize / 100 * 6 + 'px'\r\n        });\r\n        triggerCardElem.find('.alert-rule-item__name').css({'font-size': fontSize + '%'});\r\n        triggerCardElem.find('.alert-rule-item__text').css({'font-size': fontSize * 0.8 + '%'});\r\n        triggerCardElem.find('.zbx-trigger-lastchange').css({'font-size': fontSize * 0.8 + '%'});\r\n        triggerCardElem.find('.zbx-tag').css({'font-size': fontSize * 0.6 + '%'});\r\n        triggerCardElem.find('.zbx-tag').css({'line-height': fontSize / 100 * 16 + 'px'});\r\n      } else {\r\n        // remove css\r\n        triggerCardElem.find('.alert-rule-item__icon').css({'font-size': '', 'margin-right': ''});\r\n        triggerCardElem.find('.alert-rule-item__name').css({'font-size': ''});\r\n        triggerCardElem.find('.alert-rule-item__text').css({'font-size': ''});\r\n        triggerCardElem.find('.zbx-trigger-lastchange').css({'font-size': ''});\r\n        triggerCardElem.find('.zbx-tag').css({'font-size': ''});\r\n        triggerCardElem.find('.zbx-tag').css({'line-height': ''});\r\n      }\r\n    }\r\n\r\n    function renderPanel() {\r\n      let rootElem = elem.find('.triggers-panel-scroll');\r\n      let footerElem = elem.find('.triggers-panel-footer');\r\n      appendPaginationControls(footerElem);\r\n      rootElem.css({'max-height': getContentHeight()});\r\n      rootElem.css({'height': getContentHeight()});\r\n      setFontSize();\r\n      ctrl.renderingCompleted();\r\n    }\r\n\r\n    let unbindDestroy = scope.$on('$destroy', function () {\r\n      elem.off('click', '.triggers-panel-page-link');\r\n      unbindDestroy();\r\n    });\r\n  }\r\n}\r\n\r\nTriggerPanelCtrl.templateUrl = 'public/plugins/alexanderzobnin-zabbix-app/panel-triggers/partials/module.html';\r\n\r\nfunction filterTriggers(triggers, triggerFilter) {\r\n  if (utils.isRegex(triggerFilter)) {\r\n    return _.filter(triggers, function (trigger) {\r\n      return utils.buildRegex(triggerFilter).test(trigger.description);\r\n    });\r\n  } else {\r\n    return _.filter(triggers, function (trigger) {\r\n      return trigger.description === triggerFilter;\r\n    });\r\n  }\r\n}\r\n"]}